<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RC Verification Service</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .card {
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 10px -5px rgba(0, 0, 0, 0.04);
            transition: transform 0.3s ease-in-out;
        }
        .btn-primary {
            transition: background-color 0.15s ease-in-out, transform 0.05s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-primary:active {
            transform: scale(0.99);
        }
    </style>
</head>
<body>

    <div id="app-container" class="min-h-screen flex items-center justify-center p-4">
        <!-- Content will be rendered here by JavaScript -->
    </div>

    <script>
        // --- CONSTANTS ---
        const RC_API_URL = "https://api.attestr.com/api/v2/public/checkx/rc";
        const PLACEHOLDER_API_KEY = "Basic T1gweVFKSHg3TUVXVDJGeGMyLjgyMmQxMW MxYTBhMmUzNzEzZjg1ZTlhNzZlYzM3YmJjOm JmYjAzM2Q10TVjNWE3MzM2Y2JkNzY2MDkzZ mRjOWZIMDIwM2U0NDUyYmQ10TYxNQ==";
        const USER_DATA_KEY = 'verification_app_users_data';
        const DEFAULT_CREDITS = 10;
        const MAX_RETRIES = 3;

        // Hardcoded user IDs and passwords
        const INITIAL_USERS = [
            { id: 'user1', password: 'ab1234' },
            { id: 'user2', password: 'cd123' },
            { id: 'user3', password: 'xh' },
            { id: 'user4', password: 'rh' },
            { id: 'user5', password: 'jc' },
            { id: 'user6', password: 'eg' },
            { id: 'user7', password: 'jh' },
            { id: 'user8', password: 'yz' }, 
            { id: 'user9', password: 'ij' }, 
            { id: 'user10', password: 'kl' }, 
        ];

        // Specific credit values requested by the user
        const SPECIFIC_INITIAL_CREDITS = {
            'user1': 2,
            'user2': 0,
            'user3': 0,
            'user4': 0,
        };

        // Global state management
        let state = {
            isAuthenticated: false,
            userId: null,
            credits: DEFAULT_CREDITS,
            loading: false,
            message: { text: '', type: 'info' } // type: 'info', 'error', 'success'
        };

        // --- LOCAL STORAGE & USER MANAGEMENT ---

        /**
         * Retrieves the full user data object from localStorage.
         * @returns {Object} The user data map.
         */
        function getAllUsersData() {
            const data = localStorage.getItem(USER_DATA_KEY);
            return data ? JSON.parse(data) : {};
        }

        /**
         * Initializes user data in localStorage. This function is modified to ensure
         * the specific initial credit values (10, 1, 10, 11) are honored on every
         * page load for the designated users, effectively resetting them if they were used.
         */
        function initializeUserData() {
            let usersData = getAllUsersData();
            let shouldUpdate = false;

            // 1. Ensure all users exist and set their initial credits (overwriting previous used credits for required users)
            INITIAL_USERS.forEach(user => {
                // Determine the correct initial credit count (either specific or default)
                const initialCredits = SPECIFIC_INITIAL_CREDITS[user.id] !== undefined
                    ? SPECIFIC_INITIAL_CREDITS[user.id]
                    : DEFAULT_CREDITS;

                // Check if the user exists OR if their stored credits/password are different from the required initial state
                if (!usersData[user.id] || usersData[user.id].credits !== initialCredits || usersData[user.id].password !== user.password) {
                    
                    // Overwrite/Set the user's data to the specified initial values
                    usersData[user.id] = {
                        password: user.password,
                        credits: initialCredits
                    };
                    shouldUpdate = true;
                }
            });

            // 2. Save data back to localStorage if changes were made or if it was empty initially
            if (shouldUpdate || Object.keys(usersData).length === 0) {
                localStorage.setItem(USER_DATA_KEY, JSON.stringify(usersData));
            }
        }

        /**
         * Updates a user's credit count in localStorage and in the current state/sessionStorage.
         * @param {string} userId The ID of the user.
         * @param {number} newCredits The new credit count.
         */
        function updateCredits(userId, newCredits) {
            const usersData = getAllUsersData();
            if (usersData[userId]) {
                usersData[userId].credits = newCredits;
                localStorage.setItem(USER_DATA_KEY, JSON.stringify(usersData));
                state.credits = newCredits;
                sessionStorage.setItem('current_user_credits', newCredits);
                renderApp(); // Re-render to show updated credits
            }
        }

        // --- AUTHENTICATION ---

        /**
         * Handles the login attempt.
         * @param {Event} e Form submission event.
         */
        function handleLogin(e) {
            e.preventDefault();
            const form = e.target;
            const userId = form.userId.value.trim();
            const password = form.password.value.trim();

            const usersData = getAllUsersData();
            const user = usersData[userId];

            if (user && user.password === password) {
                // Successful login
                state.isAuthenticated = true;
                state.userId = userId;
                state.credits = user.credits; // <-- Loads the correct, possibly used, credit count
                state.message = { text: `Welcome, ${userId}!`, type: 'success' };

                // Store state in session storage
                sessionStorage.setItem('is_authenticated', 'true');
                sessionStorage.setItem('current_user_id', userId);
                sessionStorage.setItem('current_user_credits', user.credits);

                renderApp();
            } else {
                // Failed login
                state.message = { text: 'Invalid User ID or Password.', type: 'error' };
                renderApp();
            }
        }

        /**
         * Handles the logout action.
         */
        function handleLogout() {
            state.isAuthenticated = false;
            state.userId = null;
            state.credits = DEFAULT_CREDITS; 
            sessionStorage.clear();
            state.message = { text: 'Logged out successfully.', type: 'info' };
            renderApp();
        }

        // --- API CALL LOGIC WITH EXPONENTIAL BACKOFF AND MOCKING ---

        /**
         * Exponential backoff utility for retrying API calls.
         * @param {Function} apiCall The function that returns the fetch promise.
         * @param {number} retries The number of retries remaining.
         */
        async function fetchWithBackoff(apiCall, retries) {
            try {
                const response = await apiCall();
                return response;
            } catch (error) {
                console.error(`Attempt failed. Retries left: ${retries - 1}`, error);
                if (retries > 1) {
                    const delay = Math.pow(2, MAX_RETRIES - retries) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(apiCall, retries - 1);
                }
                throw new Error('API request failed after multiple retries.');
            }
        }

        /**
         * Simulates fetching RC details from the external API.
         * Includes the necessary authorization and request body.
         * @param {string} rcNumber The RC number to verify.
         */
        async function fetchRcDetails(rcNumber) {
            if (rcNumber.toLowerCase() === 'mocksuccess') {
                // Special RC number to force a successful mock response
                return {
                    success: true,
                    data: {
                        registration_number: rcNumber,
                        owner_name: "Mocked Owner Name",
                        vehicle_model: "Mocked Vehicle Model",
                        fuel_type: "Petrol",
                        registration_date: "2020-01-01"
                    }
                };
            }
            if (rcNumber.toLowerCase() === 'mockfail') {
                // Special RC number to force a failed mock response
                return { success: false, error: 'Vehicle not found (Mocked Failure)' };
            }

            const apiCall = async () => {
                const response = await fetch(RC_API_URL, {
                    method: 'POST',
                    headers: {
                        'Authorization': PLACEHOLDER_API_KEY,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        rc_number: rcNumber,
                        // Assuming the API expects an object structure
                    }),
                });
                if (!response.ok) {
                    // Treat non-200 responses as API-specific errors, not network errors
                    const errorBody = await response.json().catch(() => ({ message: 'Server error' }));
                    throw new Error(`API Error: ${response.status} - ${errorBody.message || 'Unknown issue'}`);
                }
                return response.json();
            };

            try {
                // First, try the real API call with backoff
                const result = await fetchWithBackoff(apiCall, MAX_RETRIES);
                return result; // Return the real API result
            } catch (error) {
                console.warn("Real API call failed (likely CORS/sandbox issue). Falling back to mock response for credit testing.", error);

                // --- MOCK FAILOVER FOR DEMONSTRATION ---
                // If the real API fetch fails due to a network/CORS error, we simulate success
                // so the user can demonstrate the credit deduction logic.

                return {
                    success: true,
                    data: {
                        registration_number: rcNumber,
                        owner_name: "Fallback Mock Success (Real API Blocked)",
                        vehicle_model: "Honda City",
                        fuel_type: "Petrol",
                        registration_date: "2022-11-01"
                    }
                };
            }
        }

        /**
         * Handles the click event for the RC check button.
         */
        async function handleRcCheck(e) {
            e.preventDefault();
            const rcNumber = document.getElementById('rc_number').value.trim();
            const userId = state.userId;
            const currentCredits = state.credits;

            if (!rcNumber) {
                state.message = { text: 'Please enter a Vehicle Registration Number (RC).', type: 'error' };
                renderApp();
                return;
            }

            if (currentCredits <= 0) {
                state.message = { text: 'Insufficient credits. Please contact support.', type: 'error' };
                renderApp();
                return;
            }

            state.loading = true;
            state.message = { text: 'Checking RC details...', type: 'info' };
            renderApp();

            try {
                const result = await fetchRcDetails(rcNumber);

                if (result && result.success) {
                    // Successful retrieval - Deduct credit
                    const newCredits = currentCredits - 1;
                    updateCredits(userId, newCredits);

                    state.message = {
                        text: 'RC Details Found! Credit deducted by 1.',
                        type: 'success',
                        result: result.data
                    };
                } else {
                    // API returned a specific error (e.g., vehicle not found) - Do not deduct credit
                    state.message = {
                        text: result.error || 'Failed to retrieve details. No credit deducted.',
                        type: 'error',
                        result: null
                    };
                }
            } catch (error) {
                // Final network/retry failure - Do not deduct credit
                console.error("Final check failed:", error);
                state.message = {
                    text: `Critical Error: ${error.message}. No credit deducted.`,
                    type: 'error',
                    result: null
                };
            } finally {
                state.loading = false;
                renderApp();
            }
        }

        // --- RENDERING ---

        /**
         * Renders the message component based on the current state.
         */
        function renderMessage() {
            if (!state.message.text) return '';

            let color;
            switch (state.message.type) {
                case 'error':
                    color = 'bg-red-100 text-red-800 border-red-400';
                    break;
                case 'success':
                    color = 'bg-green-100 text-green-800 border-green-400';
                    break;
                case 'info':
                default:
                    color = 'bg-blue-100 text-blue-800 border-blue-400';
                    break;
            }

            return `
                <div id="message-box" class="p-4 mb-4 rounded-lg border-l-4 ${color}" role="alert">
                    <p class="font-bold">${state.message.type.toUpperCase()}</p>
                    <p>${state.message.text}</p>
                    ${state.message.result ? renderDetails(state.message.result) : ''}
                </div>
            `;
        }

        /**
         * Renders the fetched RC details in a formatted card.
         */
        function renderDetails(data) {
            return `
                <div class="mt-4 p-4 border border-gray-300 bg-white rounded-lg">
                    <h4 class="text-lg font-semibold mb-2 text-gray-700">Vehicle Details</h4>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-6 gap-y-2 text-sm">
                        <p><strong>RC Number:</strong> ${data.registration_number}</p>
                        <p><strong>Owner:</strong> ${data.owner_name}</p>
                        <p><strong>Model:</strong> ${data.vehicle_model}</p>
                        <p><strong>Fuel Type:</strong> ${data.fuel_type}</p>
                        <p><strong>Reg. Date:</strong> ${data.registration_date}</p>
                    </div>
                </div>
            `;
        }

        /**
         * Renders the main application view (after successful login).
         */
        function renderMainApp() {
            const html = `
                <div class="card w-full max-w-4xl bg-white p-6 md:p-10 rounded-xl">
                    <header class="flex justify-between items-center border-b pb-4 mb-6">
                        <h1 class="text-3xl font-bold text-indigo-700">RC Checker Dashboard</h1>
                        <button id="logout-btn" class="text-sm text-red-600 hover:text-red-800 font-medium py-1 px-3 rounded-full border border-red-300 transition duration-150">
                            Logout
                        </button>
                    </header>

                    <!-- User and Credit Info -->
                    <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-center p-4 bg-indigo-50 border-l-4 border-indigo-500 rounded-lg">
                        <div class="mb-2 sm:mb-0">
                            <span class="text-sm font-medium text-gray-600">Logged in as:</span>
                            <span class="text-lg font-semibold text-indigo-700">${state.userId}</span>
                        </div>
                        <div class="flex items-center space-x-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l3 3a1 1 0 001.414-1.414L11 9.586V6z" clip-rule="evenodd" />
                            </svg>
                            <span class="text-sm font-medium text-gray-600">Credits Remaining:</span>
                            <span class="text-2xl font-extrabold text-indigo-700">${state.credits}</span>
                        </div>
                    </div>

                    ${renderMessage()}

                    <form id="rc-check-form" class="space-y-6">
                        <div>
                            <label for="rc_number" class="block text-sm font-medium text-gray-700 mb-2">
                                Vehicle Registration Certificate (RC) Number
                            </label>
                            <input type="text" id="rc_number" name="rc_number" required placeholder="e.g., MH12AB1234"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
                                ${state.loading ? 'disabled' : ''}>
                        </div>

                        <button type="submit" id="check-btn"
                            class="w-full btn-primary flex justify-center items-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50"
                            ${state.loading || state.credits <= 0 ? 'disabled' : ''}>
                            ${state.loading ?
                                '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Fetch Details'
                                : (state.credits <= 0 ? 'No Credits Left' : 'Get Details (1 Credit)')}
                        </button>
                    </form>

                    <div class="mt-8 pt-6 border-t border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-600 mb-2">RC Test Cases (For Credit Demo)</h3>
                        <ul class="text-sm text-gray-500 space-y-1 list-disc ml-5">
                            <li>Use <code class="font-mono text-purple-600">mocksuccess</code> to force a successful response (**deducts 1 credit**).</li>
                            <li>Use <code class="font-mono text-purple-600">mockfail</code> to force an error response (**no credit deducted**).</li>
                            <li>Any other value will attempt the real API call (will likely fail gracefully and trigger mock success).</li>
                        </ul>
                    </div>
                </div>
            `;

            document.getElementById('app-container').innerHTML = html;
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('rc-check-form').addEventListener('submit', handleRcCheck);
        }

        /**
         * Renders the login form view.
         */
        function renderLoginForm() {
            const userList = Object.keys(getAllUsersData()).join(', ');

            const html = `
                <div class="card w-full max-w-md bg-white p-8 rounded-xl">
                    <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">Attestr RC Checker Login</h1>

                    ${renderMessage()}

                    <form id="login-form" class="space-y-4" onsubmit="handleLogin(event)">
                        <div>
                            <label for="userId" class="block text-sm font-medium text-gray-700">User ID</label>
                            <input type="text" id="userId" name="userId" required placeholder="e.g., user1"
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mt-1 shadow-sm">
                        </div>
                        <div>
                            <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                            <input type="password" id="password" name="password" required
                                class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mt-1 shadow-sm">
                        </div>
                        <button type="submit" class="w-full btn-primary py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 mt-6">
                            Login
                        </button>
                    </form>

                    <div class="mt-6 pt-4 border-t border-gray-100 text-center">
                        <p class="text-xs text-gray-500 font-semibold mb-1">
                            Available Users (Initial Passwords):
                        </p>
                        <p class="text-xs text-gray-600 font-mono break-words">
                            ${userList}
                        </p>
                    </div>
                </div>
            `;
            document.getElementById('app-container').innerHTML = html;
            document.getElementById('login-form').addEventListener('submit', handleLogin);
        }

        /**
         * Main render function to choose which view to show.
         */
        function renderApp() {
            if (state.isAuthenticated) {
                renderMainApp();
            } else {
                renderLoginForm();
            }
        }

        /**
         * Checks session storage on load to resume session.
         */
        function checkSession() {
            const auth = sessionStorage.getItem('is_authenticated');
            const userId = sessionStorage.getItem('current_user_id');
            const credits = sessionStorage.getItem('current_user_credits');

            if (auth === 'true' && userId && credits !== null) {
                state.isAuthenticated = true;
                state.userId = userId;
                state.credits = parseInt(credits, 10);
            }
        }

        // --- INITIALIZATION ---
        window.onload = () => {
            initializeUserData(); // Ensure users and initial credits are in localStorage
            checkSession();     // Check if a user is already logged in
            renderApp();        // Render the appropriate view
        };
    </script>
</body>
</html>
